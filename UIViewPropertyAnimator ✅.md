# UIViewPropertyAnimator ✅
 
## UIViewPropertyAnimator 简介

UIViewPropertyAnimator 是一个可以让视图属性进行动画并且允许动态修改该动画的类。UIViewPropertyAnimator 类继承自 NSObject 类。下文简称 UIViewPropertyAnimator 创建的对象为「**动画对象**」。

动画对象可以对视图进行动画处理，并可以在动画完成之前动态修改该动画。动画对象也可以从头到尾正常运行动画，或者可以将它们转换为交互式动画并自行控制动画时间。 动画对象还可以对视图的可动画属性进行操作，例如 frame, center, alpha 和 transform 等属性。

简单理解就是动画对象作为一个「装载」动画（动画块）的容器，并且动画对象有固定的动画运行时间（称为总持续时间），这个时间是用来执行动画的，就像是在 UIView 类的动画方法基础上把动画时间单独拿出来交给动画对象处理。但是动画对象的持续时间并不是其创建之后就开始计时的，而是动画对象转换为活动状态时运行动画并开始计时，在动画对象的总持续时间内，还可以再「装载」其他的动画，但是这些动画的执行时间就只有动画对象剩余的可持续时间。

动画对象以编程方式控制动画的计时和执行，它在运行动画的过程中，可以被暂停、恢复、停止等，并且其对应着不同的状态，参考 UIViewAnimating 协议。

> ⚠️ **注意**
>
> 和 UIView 类的动画相同，UIViewPropertyAnimator 类的动画也是在子线程中运行。

## UIViewAnimating 协议

动画对象的大多数行为由 UIViewAnimating 协议的属性控制，UIViewPropertyAnimator 类采用该协议。UIViewAnimating 协议定义了实现动画基本流控制的方法，包括启动，暂停和停止动画的能力。 还有几个属性用于反映动画对象的当前状态以及在动画对象进行过程中修改该状态。

通常，使用此协议的方法来管理与动画对象关联的动画。 具体来说，可以使用这些方法来启动和停止动画，反转动画以及更改动画的完成进度。还可以使用这些功能来实现交互式动画，也可以采用此协议来实现自定义动画对象。

### 动画对象状态

在处理一组动画期间，动画对象在一组状态中切换。 这些状态定义了动画对象的行为，包括它如何处理变化。 在实现自己的动画对象时，必须遵守这些状态转换并准确更新状态属性。 下图显示了动画对象发生的状态之间转换的过程。

![动画对象状态转换过程](media/15508263149262/%E5%8A%A8%E7%94%BB%E5%AF%B9%E8%B1%A1%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E8%BF%87%E7%A8%8B.png)

动画对象的初始状态是非活动状态（inactive），每个新创建的动画对象都会在非活动状态下启动。 类似地，已完成动画的动画对象会返回到非活动状态。 处于非活动状态时，可以对动画对象进行一些基本配置。

当调用 startAnimation 或 pauseAnimation 方法时，动画对象会切换到活动状态（active）。 活动状态下的动画对象正在运行其动画或暂停动画。 当动画运行结束时，动画对象返回到非活动状态，以便可以使用一组新动画重新配置它。

调用 stopAnimation: 方法会停止所有正在运行的动画，并将相应视图的属性更新为动画停止时的值。 调用此方法后，动画对象将移至停止状态（stopped）或非活动状态，必须重新配置才能再次使用。

### 协议属性

- **fractionComplete** 属性

    CGFloat 类型，动画的完成百分比。

    此属性的值在动画开始时为 `0.0`，在动画结束时为 `1.0`。中间值表示动画执行的进度。

    为此属性指定新值会使动画对象将动画进度更新为指定的值。 可以使用此功能创建交互式动画。例如，可以使用平移手势识别器根据该手势的完成进度更新值。只有在动画对象暂停时（不是停止状态）才能更新此属性的值。 在非活动状态的动画对象上更改此属性的值会将其移动到活动状态。

    定义自定义动画制作工具时，如果支持动画超过其起点或终点，则可以允许大于 `1.0` 或小于 `0.0` 的值。

- **reversed** 属性

    BOOL 类型，指示动画是否在反向运行。
  
    当此属性的值为 `YES` 时，动画反方向运行，也就是说，视图属性将动画回原始值。默认值为 `NO`。

    如果在动画运行时允许更改，最好暂停动画，然后以相反方向再次启动动画。动画转换到停止状态后，可以忽略对此属性的更改。

- **state** 属性

    UIViewAnimatingState 类型，只读。动画的当前状态。
  
    此属性反映动画的当前状态。动画对象以非活动状态开始。调用 `startAnimation` 或 `pauseAnimation` 方法会切换到活动状态。更改 `fractionComplete` 属性也会将动画对象切换到活动状态。动画对象会保持活动状态直到其动画结束，动画结束后动画对象将会切换回非活动状态。

    调用 `stopAnimation:` 方法将动画对象的状态切换为停止状态。处于此状态时，动画将停止，并且在调用 `finishAnimationAtPosition:` 方法之前无法重新启动，该方法将动画对象返回到非活动状态。

    UIViewAnimatingState 是一个枚举类型，用来表示动画对象当前的状态，具体如下表：

    | UIViewAnimatingState 枚举值 | 说明 |
    | :--: | :--: |
    | UIViewAnimatingStateInactive | 动画对象处于非活动状态，此状态时动画尚未开始执行 |
    | UIViewAnimatingStateActive | 动画对象处于活动状态，动画正在运行或暂停 |
    | UIViewAnimatingStateStopped | 动画对象处于停止状态，在此状态下无法启动动画 |

- **running** 属性

    BOOL 类型，只读。指示动画当前是否正在运行。

      只有在调用 `startAnimation` 方法后，此属性的值才为 `YES`。 当动画对象暂停或停止时，该值为 `NO`。

### 协议方法

- **startAnimation** 方法

    启动动画。

    调用此方法启动动画或恢复暂停的动画。如果当前动画对象状态不是活动状态，此方法将动画对象的状态设置为活动状态。 不能在动画对象处于停止状态时调用此方法。

- **startAnimationAfterDelay:** 方法

    在指定的延迟后启动动画。

    - 参数一：NSTimeInterval 类型，开始动画之前的延迟时间（以秒为单位）。

    调用此方法在指定的时间延迟后启动动画或恢复暂停的动画。如果当前动画状态不是活动状态，此方法将动画对象的状态设置为活动状态。 不能在动画对象处于停止状态时调用此方法。

- **pauseAnimation** 方法

    暂停正在运行的动画。

    此方法暂停当前正在运行的动画。 在非活动状态的动画对象上调用此方法会将其状态切换为活动状态并立即将其动画暂停。 要恢复动画，调用 `startAnimation` 方法。 如果动画已暂停，则此方法不执行任何操作。不能在动画对象处于停止状态时调用此方法。

- **stopAnimation:** 方法

    停止正在运行的动画。

    - 参数一：BOOL 类型，指示是否应执行任何最终操作。 

    如果参数一的值指定为 YES，那么动画对象直接切换到非活动状态。如果参数一指定为 NO，动画对象会处于停止状态，随后可以手动调用 `finishAnimationAtPosition:` 方法来让动画对象执行最终的操作。

    此方法删除动画对象中添加的所有动画，并把视图动画属性的值设置为动画停止时的值。例如：动画将视图的 `alpha` 属性从 `0` 变为 `1`，如果在动画过程中 `alpha` 属性改变为 `0.5` 时停止动画，那么这个视图当前的 `alpha` 属性值就是 `0.5`。

- **finishAnimationAtPosition:** 方法

    完成动画并将动画对象返回到非活动状态。

    - 参数一：UIViewAnimatingPosition 类型。视图属性值的最终位置。 

        这个参数的作用是指定当前视图属性的值改变为动画过程中哪个位置的值。
     
    例如：动画将视图的 `alpha` 属性从 `0` 变为 `1`。如果在动画过程中 `alpha` 属性改变为 `0.5` 时调用参数为 `NO` 的 `stopAnimation:` 方法，此时这个视图当前的 `alpha` 属性值就是 `0.5`。然后随后调用了 `finishAnimationAtPosition:` 方法，这个方法的参数就能指定这个视图的的 `alpha` 属性值是要变为动画初始状态的值 `0`，还是动画结束的值 `1`，还是当前的值 `0.5`。

    动画对象处于停止状态时，才能调用此方法执行最终的任务，否则在任何时候都不能调用这个方法。

    UIViewAnimatingPosition 是一个枚举类型，用来表示动画中位置的常量，具体如下表：

    | UIViewAnimatingPosition 枚举值 | 说明 |
    | :--: | :--: |
    | UIViewAnimatingPositionCurrent | 动画停止时当前的位置 |
    | UIViewAnimatingPositionStart | 动画的开头位置 |
    | UIViewAnimatingPositionEnd | 动画的结束位置 |

## UIViewPropertyAnimator 属性和方法

### 基本属性

- **duration** 属性

    NSTimeInterval 类型，只读。动画对象的总持续时间（以秒为单位）。

    使用初始化方法创建动画对象时设置动画对象的总持续时间，以后无法更改。 动画对象处于非活动状态时添加的动画将在动画对象的总时间内运行。稍后添加的动画仅在动画对象的剩余时间内运行，动画对象剩余时间由公式 `(1.0 - fractionComplete) * duration` 确定。

- **delay** 属性

    NSTimeInterval 类型，只读。动画开始之前的延迟时间（以秒为单位）。此属性的默认值为 `0`。

    当值大于 `0` 时，动画对象中的任何动画的开始前都会延迟该值指定的时间。如果要设置此属性的值，需要在启动动画时使用 `startAnimationAfterDelay:` 方法。

- **timingParameters** 属性

    id 类型，采用 UITimingCurveProvider 协议，只读。用于确定动画的时序曲线的信息。

    时序曲线定义了动画在执行过程中不同点的速度。对于线性动画，动画的速度在总持续时间内保持不变。对于跟随曲线的动画，动画会根据曲线的斜率加速或减慢。可以在初始化时指定曲线参数，并可以使用此属性来获取这些参数。

- **interruptible** 属性

    BOOL 类型，指示动画对象是否可以中断并且可以暂停或停止，默认值为 YES。

    当此属性的值为 `YES` 时，在调用 `startAnimation` 方法后，可以使用 `pauseAnimation` 和 `stopAnimation:` 方法来中断动画并对动画进行更改。 当此属性的值为 `NO` 时，在调用 `startAnimation` 方法后，动画就不能被中断。 
  
    如果使用动画对象来实现可中断的视图控制器转换动画，则此属性必须为 `YES`。

    如果动画对象当前的 `state` 属性值不是 `UIViewAnimatingStateInactive`，则不能更改该属性。

- **userInteractionEnabled** 属性

    BOOL 类型，指示视图是否能在动画运行期间接收触摸事件。默认值为 `YES`。
  
    当此属性的值为 `YES` 时，触摸事件将正常传递给视图，即使视图正在动画中。将此属性设置为 `NO` 会使动画视图中在动画过程中（持续时间内）忽略触摸事件。 

- **pausesOnCompletion** 属性
 
    BOOL 类型，指示已运行完动画的动画对象是否保持活动状态，默认值为 `NO`。

    当此属性的值为 `YES` 时，动画运行完成后动画对象将保持 `UIViewAnimatingStateActive` 状态，并且不会执行其完成处理操作。将动画对象保持在 `UIViewAnimatingStateActive` 状态可以在动画完成后撤消动画（即还可以执行相反的动画，即动画回路）。当此属性的值为 `NO` 时，动画运行完成后，动画对象会自动转换为 `UIViewAnimatingStateInactive` 状态，从而结束动画。 

### 初始化方法

使用下列包含 `init` 开头的方法创建的动画对象都是处于非活动状态。必须通过调用 `startAnimation` 方法启动动画，将其转换为活动状态才能运行动画。而 `runningPropertyAnimatorWithDuration:delay:options:animations:completion:` 类方法会在创建完动画对象后自动启动动画。

- **initWithDuration:curve:animations:** 方法

    使用内置的 UIKit 时序曲线初始化动画对象。

    - 参数一：NSTimeInterval 类型，动画的持续时间，以秒为单位。
    - 参数二：UIViewAnimationCurve 类型，适用于动画的 UIKit 时序曲线。
    - 参数三：代码块，无返回值，设置动画结束时视图的属性值。
    - 返回值：初始化的动画对象，如果无法创建对象，则返回 `nil`。

    | UIViewAnimationCurve 枚举值 | 说明 | 
    | :--: | :--: |
    | UIViewAnimationCurveLinear | 动画匀速执行，默认值 |
    | UIViewAnimationCurveEaseInOut | 动画先缓慢，然后逐渐加速|
    | UIViewAnimationCurveEaseIn | 动画逐渐变慢 |
    | UIViewAnimationCurveEaseOut |动画逐渐加速 | 

- **initWithDuration:controlPoint1:controlPoint2:animations:** 方法

    使用三次贝塞尔定时曲线初始化动画对象。

    - 参数一：NSTimeInterval 类型，动画的持续时间，以秒为单位。
    - 参数二：CGPoint 类型，三次贝塞尔定时曲线的第一个控制点。
    - 参数三：CGPoint 类型，三次贝塞尔定时曲线的第二个控制点。
    - 参数四：代码块，无返回值，设置动画结束时视图的属性值。
    - 返回值：初始化的动画对象，如果无法创建对象，则返回 `nil`。

    此方法使用三次贝塞尔定时曲线创建动画对象，该曲线的起点为 `(0,0)` 且其终点为 `(1,1)`。参数二和参数三是定义生成的贝塞尔曲线形状的控制点。曲线的斜率定义了动画在不同时间的速度。斜率越大，则动画运行的越快。
  
    下图显示了一个时序曲线，其中动画在开始和结束时运行较快，但在中间部分运行较慢。
   
    ![贝塞尔定时曲线示例图](media/15508263149262/%E8%B4%9D%E5%A1%9E%E5%B0%94%E5%AE%9A%E6%97%B6%E6%9B%B2%E7%BA%BF%E7%A4%BA%E4%BE%8B%E5%9B%BE.png)


- **initWithDuration:dampingRatio:animations:** 方法

    使用基于物理弹簧的运动相对应的定时曲线初始化动画对象。

    - 参数一：NSTimeInterval 类型，动画的持续时间，以秒为单位。
    - 参数二：CGFloat 类型，弹簧动画接近其静止状态时的阻尼比。该值越接近 `0`，则振荡越大。如果要要设置为没有振动并平滑地减速动画，则将该值设置为 `1.0`。
    - 参数三：代码块，无返回值，设置动画结束时视图的属性值。
    - 返回值：初始化的动画对象，如果无法创建对象，则返回 `nil`。

- **initWithDuration:timingParameters:** 方法

    使用自定义时序曲线对象初始化动画对象。

    - 参数一：NSTimeInterval 类型，动画的持续时间，以秒为单位。
    - 参数二：id 类型，采用 UITimingCurveProvider 协议对象，提供时序信息。
    - 返回值：初始化的动画对象，如果无法创建对象，则返回 `nil`。

    使用此方法可以使用自定义时序曲线初始化动画对象。 初始化动画对象后，必须在调用动画之前添加一个或多个动画块。

- **runningPropertyAnimatorWithDuration:delay:options:animations:completion:** 类方法

    创建并返回一个动画对象，该对象立即开始运行其动画。

    - 参数一：NSTimeInterval 类型，动画的持续时间，以秒为单位。
    - 参数二：NSTimeInterval 类型，开始动画的等待时间，以秒为单位。设置为 `0` 可立即开始动画。
    - 参数三：UIViewAnimationOptions 类型，动画的选项。 可以指定大多数选项，但忽略与动画方向和动画转换相关的选项。 
    - 参数四：代码块，无返回值，设置动画结束时视图的属性值。
    - 参数五：代码块，无返回值，设置动画结束时要执行的内容。这个代码块包含一个 UIViewAnimatingPosition 类型的参数，用于设置动画的结束位置。使用此值可确定动画是在开头，结尾还是中间的某个位置停止。
    - 返回值：初始化的动画对象，如果无法创建对象，则返回 `nil`。

    此方法创建的动画对象，对其进行配置，并在指定的延迟后自动调用其 `startAnimation` 方法。 如果未在参数三中指定动画曲线，则此方法使用 UIViewAnimationOptionCurveEaseInOut 选项。

### 运行和修改动画的方法

- **addAnimations:** 方法

    将指定的动画块添加到动画对象。

    - 参数一：代码块，无返回值，设置动画结束时视图的属性值。此参数不能为 `nil`。

    使用此方法将新动画块添加到动画对象。新动画块中的动画与任何先前配置的动画一起运行。在动画对象处于非活动状态时添加的动画块会在动画总持续时间内运行；在动画对象处于活动状态时添加的动画块会在总持续时间的剩余部分执行。
  
    例如，如果总持续时间为 `2.0` 秒并且将动画块添加到其 `fractionComplete` 属性为 `0.5` 的正在运行的动画对象，则动画将运行 `1.0` 秒。**在动画对象运行时添加的任何块都会立即开始执行。**

    如果动画块修改了由不同动画对象修改的属性，则动画对象会以最合适的方式组合它们的更改。对于许多属性，每个动画对象的更改会相加，以产生新的中间值。 如果无法以此附加方式修改属性，则新动画将接管，就像为基于视图的动画指定了 UIViewAnimationOptionBeginFromCurrentState 选项一样。

    可以多次调用此方法以向动画对象添加多个动画块。当动画对象处于停止状态时，不能调用此方法。

- **addAnimations:delayFactor:** 方法

    在指定的延迟之后，将指定的动画块添加到动画对象。

    - 参数一：代码块，无返回值，设置动画结束时视图的属性值。此参数不能为 `nil`。
    - 参数二：CGFloat 类型，用于延迟动画开始的因素。 指定的值必须介于 `0.0` 和 `1.0` 之间。 
    
    此值乘以动画对象的剩余持续时间，以确定以秒为单位的实际延迟。例如，当持续时间为 `2.0` 时指定值 `0.5` 会导致动画开始时间延迟一秒。

    此方法的作用和 `addAnimations:` 方法相同，只是增加了添加动画的延迟时间。

- **addCompletion:** 方法

    为动画对象添加动画完成后执行的处理。

    - 参数一：代码块，动画完成时的处理。没有返回值，采用以下参数：
    
        - 参数一：动画的结束位置。 使用此值可确定动画是在开头，结尾还是中间的某个位置停止。

    如果调用 `stopAnimation:` 方法，并且方法的参数指定为 `YES`，则不会调用完成处理的代码块。如果为参数指定为 `NO`，则在调用其 `finishAnimationAtPosition:` 方法后，动画对象会执行完成处理的代码块。

    可以随时向动画对象添加完成处理的代码块，包括停止时。

