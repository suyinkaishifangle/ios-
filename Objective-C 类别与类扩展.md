# Objective-C 类别与类扩展

## 类别（Category）

Objective-C 的动态特征允许使用「**类别**」为现有的类添加新方法，并且不需要创建子类，不需要访问原有类的代码。所以类别可以向没有源代码的类（例如 Cocoa 中的类）添加新方法。

类别的命名通常以「类名称 + 类别名称」构成，因为类别是基于已有类的，所以这里的「类名称」就是该类的名称，而「类别名称」则根据用途等自定义。

### 类别的作用

类别的主要作用有四个：

- 利用类别对类进行模块化设计
- 使用类别来调用私有方法
- ~~使用类别来实现非正式协议~~（非正式协议已经被正式协议中的 `@optional` 替代）
- 使用类别来覆盖类中的方法

> ⚠️ 使用类别的注意事项
> 
> - 只要保证类别名称唯一，可以向类添加任意数量的类别。
> - 不能在类别中添加成员变量，但是可以添加属性，且属性必须使用 `@dynamic` 修饰（即必须手动实现属性的 getter 和 setter 方法）。
> - 为类添加类别之后，该类的所有子类也会获取到类别中的方法。但是一个类别不能获取到另一个类别中的方法。

#### 利用类别对类进行模块化设计

在类的文件中，使用 .m 文件存放类的实现部分，但是不能够把实现部分的代码放在多个 .m 文件中。如果某一个类的实现文件特别大，会影响维护。使用类别可以将其分成多个模块来实现，从而实现后期的可维护性。例如：将一个项目的网络请求类方法分散到多个类别中，提高可读性和可维护性。

#### 利用类别来调用私有方法

在一个类中没有定义在 .h 文件中的方法就是私有方法，不允许外部调用。但是 Objective-C 中没有真正的私有方法，使用 NSObject 的 `performSelector:` 方法执行动态调用即可调用私有方法。但是这种方式避开了编译器的语法检查，有时候未必是一种好的做法。

可以使用类别来定义**前向引用**[^前向引用]，从而实现对私有方法的调用。

例如在一个类的接口文件中定义一个方法 A，该方法可以被外部调用，而类的实现中还有另外一个方法 B，无法被外部调用。此时为这个类创建一个类别，在类别的接口文件中声明了方法 B，那么此时方法 B 也能够被外部调用。

[^前向引用]: 前向引用（forward reference）：表示一个实体在声明前即被实际使用。

#### 使用类别来覆盖类中的方法

很多资料只提到了类别的前三种作用，而在《Objective-C 基础教程》第二版中，提到了使用类别来覆盖类中的方法。其中是这样描述的：「如果类别中的方法与现有的方法重名。当发生名称冲突时，类别具有更高的优先级。类别方法将完全取代类中的初始方法，导致初始方法不再可用」。

其实在实际开发中，很少使用类别的这种作用。但是在某些情况下，类别的这种作用却非常有帮助。比如在没有源代码的 Cocoa 类中，可以通过重写 Cocoa 类中的方法来达到自己的目的。例如在 Xcode 控制台中打印出来的中文字符是 Unicode 代码，可以通过使用类别的方式来覆盖 NSDictionary 和 NSArray 中的 `descriptionWithLocale:indent:` 方法来将 Unicode 代码转成中文字符，这样就可以在控制台中打印出中文字符。

### 创建类别文件

类别和类一样，类别也有 @interface 部分（可以没有）和 @implementation 部分。@interface 部分一般放在接口文件中，声明外部类可以调用的方法。@implementation 部分放在实现文件中，包含方法的具体实现。

在 Xcode 10.0 中创建类别文件的方式之一：

 ⚙️ **File ➤ New ➤ File... ➤ Source ➤ Objective-C File ➤ Next ➤ File type：Category**。

其中最后一步中的 `File` 是类别名，`class` 就是该类别基于的类，然后系统会自动生成「类名称 + 类别名称」的接口文件和实现文件。

## 类扩展（class extension）

类扩展是一个特殊的类别，它是没有名字的类别，即匿名的类别。

类扩展的特点如下：

- 它不需要名字
- 创建数量不限
- 可以包含在原类的文件中（一般放在 .m 文件中）
- 可以添加成员变量、属性和方法（实际开发中一般只用来添加属性）
- 可以将只读权限改写成可读写的权限
- 只有 `@interface` 部分，没有 `@implementation` 部分
- 类扩展声明的成员变量、方法和属性等都是私有的，仅在本类中使用

> ⚠️ **注意**
> 
> 在类别中声明属性必须使用 `@dynamic` 修饰，但是在类扩展中声明属性却不需要。

扩展的语法如下：

```Objective-C
@interface 类名称 ()
{
    // 声明成员变量
    ...
}
// 声明方法或属性
...
@end
```

### 类扩展的作用

#### 修改属性的权限

假如在 A 的接口文件中定义了一个只读属性 textLabel，在 A 的实现文件中添加 A 的类扩展，声明 textLabel 属性为可读可写。那么这个类 A 的 textLabel 属性在外部是只读的，但是在内部就是可读可写的。

示例代码：接口文件

```Objective-C
@interface A : NSObject

// 外部调用时只读
@property(nonatomic, readonly) UILabel *textLabel;

@end
```

示例代码：实现文件

```Objective-C
@interface A ()

// 内部调用时可读可写
@property(nonatomic, readwrite) UILabel *textLabel;

@end

@implementation A

...

@end
```

#### 限制属性的使用范围

在类扩展中声明的属性，这个属性就只能被该类访问，而外部无法访问到这个属性。


